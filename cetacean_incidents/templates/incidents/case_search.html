{% extends "base.html" %}
{% load animal_extras %}
{% load case_extras %}
{% load observation_extras %}

{% block head %}
{{ block.super }}
<script type="text/javascript" src="{% url site-media path="sorttable/sorttable.js" %}"></script>
<link rel="stylesheet" type="text/css" href="{% url site-media path="sorttable/sorttable.css" %}">
{{ form.media }}
{% endblock %}

{% block title %}{{ block.super }}: Cases{% endblock %}

{% block header %}<h2>Cases</h2>{% endblock %}

{% block content %}
<form action="{% url case_search %}" method="get">
    <div class="section">
        {% with form.non_field_errors as errors %}
        {% if errors %}
        <ul class="errorlist">
            {% for e in errors %}
            <li>{{ e }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endwith %}
        {% for f in form %}
        {% include "labeled_field.html" %}
        {% endfor %}
        <button type="submit">search</button>
    </div>
</form>
{% if form.is_bound %}
<div style="text-align: center;">
    ({{ case_count|default:"no" }} matching case{{ case_count|pluralize }})
</div>{# sorttable.js doesn't like empty tables #}
{% if case_count > 0 %}
<table{% if case_list %} class="bordered sortable"{% endif %}>
    <thead>
        <tr>
            <th class="sorttable_nosort"><!-- case edit link --></th>
            <th>case</th>
            <th class="sorttable_nosort">animal</th>
            <th>first observed</th>
            <th>last observed</th>
            <th># obs.</th>
        </tr>
    </thead>
    <tbody>
        {% for case in case_list %}
        <tr>
            {# the case-editing page can also change animals #}
            {% if perms.incidents.change_animal and perms.incidents.change_case %}
            <td>
                <a href="{{ case.detailed.get_edit_url }}#case">
                    <img src="{{ MEDIA_URL}}icons/edit.png" alt="edit" title="edit this case">
                </a>
            </td>
            {% endif %}
            <td sorttable_customkey="{{ case.nmfs_id|default:"A00-00" }} {{ ycn.year|default:9999 }}{{ ycn.number|default:0|stringformat:"04d" }}{{ case.id|stringformat:"04d" }}">
                {% case_link case %}
            </td>
            <td>{% animal_link case.animal %}</td>
	        {# these assume datetimes are sorted from less recent to more recent #}
	        {% with case.observation_set.all as obs %}
	        {% with obs.0 as first_obs_date %}
	        <td sorttable_customkey="{{ first_obs_date.sortkey }}">{{ first_obs_date }}</td>
	        {% endwith %}
	        {% with obs.reverse.0 as last_obs_date %}
	        <td sorttable_customkey="{{ last_obs_date.sortkey }}">{{ last_obs_date }}</td>
	        {% endwith %}
            {% endwith %}
    	    <td>{{ case.observation_set.count }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %} {# case_count > 0 #}
{% else %} {# form.is_bound #}
<p>click 'search' to see a list of cases</p>
{% endif %} {# form.is_bound #}
{% endblock %}

