{% extends "detail.html" %}
{% load animal_extras %}
{% load case_extras %}

{% block head %}
{{ block.super }}
<!-- all media -->
{{ all_media }}
<!-- template JS -->
<script type="text/javascript">
    $(function(){
        var $tabs = $('#tabs').tabs();
        
        $('.link-to-animal').click(function() { // bind click event to link
            $tabs.tabs('select', '#animal'); // switch to animal tab
            return false;
        });
        $('.link-to-case').click(function() { // bind click event to link
            $tabs.tabs('select', '#case'); // switch to case tab
            return false;
        });
        $('.link-to-case-sinmd').click(function() { // bind click event to link
            $tabs.tabs('select', '#case-sinmd'); // switch to case tab
            return false;
        });
        $('.link-to-reporting').click(function() { // bind click event to link
            $tabs.tabs('select', '#reporting'); // switch to reporting tab
            return false;
        });
        $('.link-to-observation').click(function() { // bind click event to link
            $tabs.tabs('select', '#observation'); // switch to observation tab
            return false;
        });
        $('.link-to-animal-identification').click(function() { // bind click event to link
            $tabs.tabs('select', '#animal-identification'); // switch to animal tab
            return false;
        });
        $('.link-to-incident').click(function() { // bind click event to link
            $tabs.tabs('select', '#incident'); // switch to incident tab
            return false;
        });
        $('.link-to-narrative').click(function() { // bind click event to link
            $tabs.tabs('select', '#narrative'); // switch to save tab
            return false;
        });
        {% block other_tabs_js %}{% endblock %}
    });
</script>
<style type="text/css">
    [name={{ forms.observation.narrative.html_name }}] { width: 100%; }
</style>
{% endblock %}

{% block title %}{{ block.super }}: {% block case_title %}{{ case|default:"new case" }}{% endblock %}: {% if observation %}{{ observation }} [editing]{% else %}new observation{% endif %}{% endblock %}

{% block ids %}
{% if animal %}
{{ block.super }}
{% endif %}
{% endblock %}

{% block ids-dl %}
{% with animal as a %}
{% include "incidents/animal_ids_include.html" %}
{% endwith %}
{% if case %}
<hr>
{% block case_ids %}
{% with case as c %}
{% include "incidents/case_ids_include.html" %}
{% endwith %}
{% endblock case_ids %}
{% endif %}
{% endblock ids-dl %}

{% block header %}
{% if case.ole_investigation %}
{% include "incidents/ole-warning.html" %}
{% endif %}
<h2>{{ animal|default:"<i>new animal</i>" }}</h2>
<h2 style="margin-left:1em;">{% block case_header %}{{ case|default:"<i>new case</i>" }}{% endblock %}</h2>
<h2 style="margin-left:2em;">{{ observation|default:"<i>new observation</i>" }}</h2>
{% endblock %}

{% block content %}
<form action="" method="post">
    <button type="submit">
        {% block submit_button %}
        {% if observation.id %}
        save changes to this observation and {{ case }} and {{ animal }}
        {% else %}{% if case.id %}
        add a new observation to {{ case }} and save changes to it and {{ animal }}
        {% else %}{% if animal.id %}
        add a new case and its initial observation for {{ animal }} and save changes to {{ animal }}
        {% else %}
        add a new animal and its first case and that case's initial observation
        {% endif %}{% endif %}{% endif %}
        {% endblock %}
    </button>
    {% csrf_token %}
    <div id="tabs">
        <ul>
            <li{% if forms.animal.errors %} class="ui-state-error"{% endif %}>
                <a href="#animal">
                    <em>Animal</em>
                    <br>&nbsp;
                </a>
            </li>
            {% block case_tab %}
            <li{% if forms.case.non_field_errors or forms.case.nmfs_id.errors or forms.case.animal.errors or forms.case.happened_after.errors or forms.case.valid.errors or forms.case.ole_investigation.errors %} class="ui-state-error"{% endif %}>
                <a href="#case">
                    <em>Case</em>
                    <br>&nbsp;
                </a>
            </li>
            {% endblock %}
            {% block other_case_tabs %}{% endblock %}
            <li{% if forms.case.non_field_errors or forms.case.review_1_date.errors or forms.case.review_1_inits.errors or forms.case.review_2_date.errors or forms.case.review_2_inits.errors or forms.case.case_confirm_criteria.errors or forms.case.animal_fate.errors or forms.case.fate_cause.errors or forms.case.fate_cause_indications.errors or forms.case.si_prevented.errors or forms.case.included_in_sar.errors or forms.case.review_1_notes.errors or forms.case.review_2_notes.errors %} class="ui-state-error"{% endif %}>
                <a href="#case-sinmd">
                    <em>Case</em>
                    <br><abbr title="Serious Injury and Mortality Determination">SI&MD</abbr>
                </a>
            </li>
            {# TODO check for errors on forms.new_reporter_affiliations #}
            <li{% if forms.observation.non_field_errors or forms.observation.report_datetime.errors or forms.observation.new_reporter.errors or forms.new_reporter.errors or forms.observation.reporter.errors %} class="ui-state-error"{% endif %}>
                <a href="#reporting">
                    <em>Observation</em>
                    <br>Reporter
                </a>
            </li>
            {# TODO check for errors on forms.new_observer_affiliations #}
            {# TODO check for errors on forms.new_vesselcontact_affiliations #}
            <li{% if forms.observation.non_field_errors or forms.observation.observation_datetime.errors or forms.observation.new_observer.errors or forms.new_observer.errors or forms.observation.observer.errors or forms.location.errors or forms.observation.observer_on_vessel.errors or forms.observer_vessel.errors or forms.new_vesselcontact.errors %} class="ui-state-error"{% endif %}>
                <a href="#observation">
                    <em>Observation</em>
                    <br>Observer
                </a>
            </li>
            <li{% if forms.observation.non_field_errors or forms.observation.taxon.errors or forms.observation.gender.errors or forms.observation.animal_descriptions.errors or forms.observation.biopsy.errors or forms.observation.tagged.errors %} class="ui-state-error"{% endif %}>
                <a href="#animal-identification">
                    <em>Observation</em>
                    <br>Animal Identification
                </a>
            </li>
            {% block incident_tab %}
            <li{% if forms.observation.non_field_errors or forms.observation.documentation.errors or forms.observation.wounded.errors or forms.observation.wound_description.errors %} class="ui-state-error"{% endif %}>
                <a href="#incident">
                    <em>Observation</em>
                    <br>Incident
                </a>
            </li>
            {% endblock %}
            {% block other_observation_tabs %}{% endblock %}
            <li{% if forms.observation.non_field_errors or forms.observation.narrative.errors %} class="ui-state-error"{% endif %}
>
                <a href="#narrative">
                    <em>Observation</em>
                    <br>Narrative
                </a>
            </li>
        </ul>

        <div id="animal">
            {{ forms.animal.non_field_errors }}
            {# TODO this arithmatic isn't correct for adding new observations #}
            {% if case.animal.case_set.count > 1 or case.animal.observation_set.count > 1 %}
            <div class="edit-warning">
                <img
                    src="{% url site-media path="icons/warning.png"%}"
                >
                Note that this is the animal data for {% if case.animal.case_set.count > 1 %}{{ case.animal.case_set.count|add:"-1" }} other case{{ case.animal.case_set.count|add:"-1"|pluralize }} and {% endif %} {{ case.animal.observation_set.count|add:"-1" }} other observation{{ case.animal.observation_set.count|add:"-1"|pluralize }}.
                <img
                    src="{% url site-media path="icons/warning.png"%}"
                >
            </div>
            {% endif %}
            {{ forms.animal.as_p }}
            <div style="text-align: right;">
                <a class="link-to-case" href="#case">next tab &#x2192;</a>
            </div>
        </div> <!-- id="animal" -->

        <div id="case">
            {{ forms.case.non_field_errors }}
            {% if case.observation_set.count > 1 %}
            <div class="edit-warning">
                <img
                    src="{% url site-media path="icons/warning.png"%}"
                >

                Note that this is the case data for {{ case.observation_set.count|add:"-1" }} other observation{{ case.observation_set.count|add:"-1"|pluralize }}.
                <img
                    src="{% url site-media path="icons/warning.png"%}"
                >
            </div>
            {% endif %}
            {% block case_tab_body %}
            {% with forms.case.nmfs_id as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.animal as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.happened_after as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.valid as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.ole_investigation as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% endblock %}
            <div style="text-align:left; float: left;">
                <a class="link-to-animal" href="#animal">&#x2190; previous tab</a>
            </div>
            <div style="text-align: right;">
                {% block other_case_tabs_next_link %}<a class="link-to-case-sinmd" href="#case-sinmd">{% endblock %}next tab &#x2192;</a>
            </div>
        </div> <!-- id="case" -->
        
        {% block other_case_tabs_body %}{% endblock %}
        
        <div id="case-sinmd">
            {{ forms.case.non_field_errors }}
            {% if case.observation_set.count > 1 %}
            <div class="edit-warning">
                <img
                    src="{% url site-media path="icons/warning.png"%}"
                >
                Note that this is the case data for {{ case.observation_set.count|add:"-1" }} other observation{{ case.observation_set.count|add:"-1"|pluralize }}.
                <img
                    src="{% url site-media path="icons/warning.png"%}"
                >
            </div>
            {% endif %}
            {% with forms.case.review_1_date as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.review_1_inits as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.review_2_date as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.review_2_inits as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.case_confirm_criteria as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.animal_fate as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.fate_cause as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.fate_cause_indications as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.si_prevented as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.included_in_sar as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.review_1_notes as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.case.review_2_notes as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            <div style="text-align:left; float: left;">
                {% block other_case_tabs_prev_link %}<a class="link-to-case" href="#case">{% endblock %}&#x2190; previous tab</a>
            </div>
            <div style="text-align: right;">
                <a class="link-to-reporting" href="#reporting">next tab &#x2192;</a>
            </div>
        </div> <!-- id="case-sinmd" -->

        <div id="reporting">
            {{ forms.observation.non_field_errors }}
            <div class="section">
                <h4>report date and time</h4>
                {% with forms.observation.report_datetime as f %}
                {% include "unlabeled_field.html" %}
                {% endwith %}
            </div>
            <div class="section">
                <h4>reporter</h4>
                <script type="text/javascript">
                    $().ready(function(){
                        RadioHider.init('{{ forms.observation.new_reporter.html_name }}', {
                            {# TODO? get the keys from forms.observation.new_reporter.field #}
                            'new': 'reporter_new_contact',
                            'other': 'reporter_existing_contact'
                        });
                    });
                </script>
                {% with forms.observation.new_reporter as f %}
                {% include "unlabeled_field.html" %}
                {% endwith %}
                <div id="reporter_new_contact" style="display:none;">
                    {% if perms.contacts.add_contact %}
                    {% with forms.new_reporter as form %}
                    {% with forms.new_reporter_affiliations as  new_affiliations %}
                    {% include "contacts/change_contact_include.html" %}
                    {% endwith %}
                    {% endwith %}
                    {% else %}
                    <div class="warning">you don't have permission to add a new contact</div>
                    {% endif %}
                </div>
                <div id="reporter_existing_contact" style="display:none;">
                    {% with forms.observation.reporter as f %}
                    {% include "unlabeled_field.html" %}
                    {% endwith %}
                </div>
            </div>
            <div style="text-align:left; float: left;">
                <a class="link-to-case-sinmd" href="#case-sinmd">&#x2190; previous tab</a>
            </div>
            <div style="text-align: right;">
                <a class="link-to-observation" href="#observation">next tab &#x2192;</a>
            </div>
        </div> <!-- id="reporting" -->

        <div id="observation">
            {{ forms.observation.non_field_errors }}
            <div class="section">
                <h4>observation date and time</h4>
                {% with forms.observation.observation_datetime as f %}
                {% include "unlabeled_field.html" %}
                {% endwith %}
            </div>
            <div class="section">
                <h4>observer</h4>
                <script type="text/javascript">
                    $().ready(function(){
                        RadioHider.init('{{ forms.observation.new_observer.html_name }}', {
                            {# TODO get the values from forms.observation.new_observer.field #}
                            'new': 'observer_new_contact',
                            'other': 'observer_existing_contact'
                        });
                    });
                </script>
                {% with forms.observation.new_observer as f %}
                {% include "unlabeled_field.html" %}
                {% endwith %}
                <div id="observer_new_contact" style="display:none;">
                    {% if perms.contact.add_contact %}
                    {% with forms.new_observer as form %}
                    {% with forms.new_observer_affiliations as  new_affiliations %}
                    {% include "contacts/change_contact_include.html" %}
                    {% endwith %}
                    {% endwith %}
                    {% else %}
                    <div class="warning">you don't have permission to add a new contact</div>
                    {% endif %}
                </div>
                <div id="observer_existing_contact" style="display:none;">
                    {% with forms.observation.observer as f %}
                    {% include "unlabeled_field.html" %}
                    {% endwith %}
                </div>
            </div> <!-- class="section" -->
            <div class="section">
                <h4>observation location</h4>
                {% with forms.location as l_form %}
                {% include "locations/edit_location_include.html" %}
                {% endwith %}
            </div>
            <div class="section">
                {% with forms.observation.observer_on_vessel as f %}
                {% include "labeled_field.html" %}
                {% endwith %}
                <script type="text/javascript">
                    $().ready(function(){
                        CheckboxHider.init(
                            "{{ forms.observation.observer_on_vessel.html_name}}",
                            'vessel_info'
                        );
                    });
                </script>
                <div id="vessel_info">
                    <h4>vessel info for observer's vessel</h4>
                    {% with forms.observer_vessel as v_form %}
                    {% with forms.new_vesselcontact as c_form %}
                    {% with forms.new_vesselcontact_affiliations as c_aff_form %}
                    {% include "vessels/edit_vessel_include.html" %}
                    {% endwith %}
                    {% endwith %}
                    {% endwith %}
                </div>
            </div> <!-- class="section" -->
            <div style="text-align:left; float: left;">
                <a class="link-to-reporting" href="#reporting">&#x2190; previous tab</a>
            </div>
            <div style="text-align: right;">
                <a class="link-to-animal-identification" href="#animal-identification">next tab &#x2192;</a>
            </div>
        </div> <!-- id="observation" -->

        <div id="animal-identification">
            {{ forms.observation.non_field_errors }}
            <table>
                <tr>
                    <th>taxon</th>
                    <td>
                        {% if animal.id and animal.determined_taxon %}
                        <div class="edit-warning">
                            <img
                                src="{% url site-media path="icons/warning.png"%}"
                            >
                            Note that this animal has been determined to be a <i>{{ animal.determined_taxon }}</i>.
                            <img
                                src="{% url site-media path="icons/warning.png"%}"
                            >
                        </div>
                        {% endif %}
                        {% with forms.observation.taxon as f %}
                        {% include "unlabeled_field.html" %}
                        {% endwith %}
                    </td>
                </tr>
                <tr>
                    <th>sex</th>
                    <td>
                        {% if animal.id and animal.determined_gender %}
                        <div class="edit-warning">
                            <img
                                src="{% url site-media path="icons/warning.png"%}"
                            >
                            Note that this animal has been determined to be {{ animal.get_determined_gender_display }}.
                            <img
                                src="{% url site-media path="icons/warning.png"%}"
                            >
                        </div>
                        {% endif %}
                        {% with forms.observation.gender as f %}
                        {% include "unlabeled_field.html" %}
                        {% endwith %}
                    </td>
                </tr>
                <tr>
                    <th>description</th>
                    <td>
                        {% with forms.observation.animal_description as f %}
                        {% include "bigtext_field.html" %}
                        {% endwith %}
                    </td>
                </tr>
            </table>
            <div>
                {% with forms.observation.biopsy as f %}
                {% include "labeled_field.html" %}
                {% endwith %}
                {% with forms.observation.tagged as f %}
                {% include "labeled_field.html" %}
                {% endwith %}
            </div>
            <div style="text-align:left; float: left;">
                <a class="link-to-observation" href="#observation">&#x2190; previous tab</a>
            </div>
            <div style="text-align: right;">
                <a class="link-to-incident" href="#incident">next tab &#x2192;</a>
            </div>
        </div> <!-- id="animal-identification" -->

        <div id="incident">
            {{ forms.observation.non_field_errors }}
            {% block incident_tab_body %}
            {% with forms.observation.documentation as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.observation.wounded as f %}
            {% include "labeled_field.html" %}
            {% endwith %}
            {% with forms.observation.wound_description as f %}
            {% include "bigtext_field.html" %}
            {% endwith %}
            {% endblock %}
            <div style="text-align:left; float: left;">
                <a class="link-to-animal-identification" href="#animal-identification">&#x2190; previous tab</a>
            </div>
            <div style="text-align: right;">
                {% block other_observation_tabs_next_link %}<a class="link-to-narrative" href="#narrative">{% endblock %}next tab &#x2192;</a>
            </div>
        </div> <!-- id="incident" -->
        
        {% block other_observation_tabs_body %}{% endblock %}
        
        <div id="narrative">
            {{ forms.observation.non_field_errors }}
            <h3>Narrative</h3>
            <div>
                {% with forms.observation.narrative as f %}
                {% include "unlabeled_field.html" %}
                {% endwith %}
            </div>
            <div style="text-align:left; float: left;">
                {% block other_observation_tabs_prev_link %}<a class="link-to-incident" href="#incident">{% endblock %}&#x2190; previous tab</a>
            </div>
        </div>
    </div> <!-- id="tabs" -->
</form>
{% endblock content %}

