{% extends "detail.html" %}
{% load animal_extras %}
{% load case_extras %}

{% block head %}
{{ block.super }}
<!-- all media -->
{{ all_media }}
<!-- template JS -->
<script type="text/javascript">
    $(function(){
        var $tabs = $('#tabs').tabs();
        
        $('.link-to-animal').click(function() { // bind click event to link
            $tabs.tabs('select', '#animal'); // switch to animal tab
            return false;
        });
        $('.link-to-case').click(function() { // bind click event to link
            $tabs.tabs('select', '#case'); // switch to case tab
            return false;
        });
        $('.link-to-reporting').click(function() { // bind click event to link
            $tabs.tabs('select', '#reporting'); // switch to reporting tab
            return false;
        });
        $('.link-to-observation').click(function() { // bind click event to link
            $tabs.tabs('select', '#observation'); // switch to observation tab
            return false;
        });
        $('.link-to-animal-identification').click(function() { // bind click event to link
            $tabs.tabs('select', '#animal-identification'); // switch to animal tab
            return false;
        });
        $('.link-to-incident').click(function() { // bind click event to link
            $tabs.tabs('select', '#incident'); // switch to incident tab
            return false;
        });
        $('.link-to-save').click(function() { // bind click event to link
            $tabs.tabs('select', '#save'); // switch to save tab
            return false;
        });
    });
</script>
<style type="text/css">
    [name={{ forms.observation.narrative.html_name }}] { width: 100%; }
</style>
{% endblock %}

{% block title %}{{ block.super }}: {{ case }}: {% block observation_title %}NO TITLE!{% endblock %}{% endblock %}

{% block ids-dl %}
{% with observation.case.animal as a %}
{% include "incidents/animal_ids_include.html" %}
{% endwith %}
<hr>
{% block case_ids %}
{% with observation.case as c %}
{% include "incidents/case_ids_include.html" %}
{% endwith %}
{% endblock %}
{% endblock %}

{% block header %}
{% if case.ole_investigation %}
{% include "incidents/ole-warning.html" %}
{% endif %}
<h2>{{ case }}</h2>
<h2 style="margin-left:2em;">{% block observation_header %}NO HEADER!{% endblock %}</h2>
{% endblock %}

{% block content %}
<form action="" method="post">
    {% csrf_token %}
    <div>
        <div id="tabs">
            <ul>
                <li>
                    <a href="#animal">
                        Animal
                        {% if forms.animal.errors %}
                        <div class="ui-state-error">errors!</div>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a href="#case">
                        Case
                        {% if forms.case.errors %}
                        <div class="ui-state-error">errors!</div>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a href="#reporting">
                        Reporting
                        {% if forms.report_datetime.errors or forms.observation.new_reporter.errors or forms.new_reporter.errors or forms.observation.reporter.errors or forms.observation.documentation.errors %}
                        <div class="ui-state-error">errors!</div>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a href="#observation">
                        Observation
                        {% if forms.observation.new_observer.errors or forms.new_observer.errors or forms.observation.observer.errors or forms.observation.datetime.errors or forms.location.errors or forms.observation.observer_on_vessel.errors or forms.observer_vessel.errors or forms.new_vesselcontact.errors %}
                        <div class="ui-state-error">errors!</div>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a href="#animal-identification">
                        Animal Identification
                        {% if forms.observation.taxon.errors or forms.observation.gender.errors or forms.observation.animal_description.errors or forms.observation.biopsy.errors %}
                        <div class="ui-state-error">errors!</div>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a href="#incident">
                        {% block incident_tab %}
                        Incident
                        {% if forms.observation.wound_description.errors %}
                        <div class="ui-state-error">errors!</div>
                        {% endif %}
                        {% endblock %}
                    </a>
                </li>
                <li>
                    <a href="#save">
                        {% block save_tab %}
                        Narrative & Save
                        {% if forms.observation.narrative.errors %}
                        <span class="ui-state-error">errors in this tab!</span>
                        {% endif %}
                        {% endblock %}
                    </a>
                </li>
            </ul>
            <div id="animal">
                <h3>Animal</h3>
                {# TODO this arithmatic isn't correct for adding new observations #}
                {% if case.animal.case_set.count > 1 or case.animal.observation_set.count > 1 %}
                <div class="edit-warning">
                    <img
                        src="{% url site-media path="icons/warning.png"%}"
                    >
                    Note that this is the animal data for {% if case.animal.case_set.count > 1 %}{{ case.animal.case_set.count|add:"-1" }} other case{{ case.animal.case_set.count|add:"-1"|pluralize }} and {% endif %} {{ case.animal.observation_set.count|add:"-1" }} other observation{{ case.animal.observation_set.count|add:"-1"|pluralize }}.
                    <img
                        src="{% url site-media path="icons/warning.png"%}"
                    >
                </div>
                {% endif %}
                {{ forms.animal.as_p }}
                <div style="text-align: right;">
                    <a class="link-to-case" href="#case">next tab -&gt;</a>
                </div>
            </div> <!-- id="animal" -->
            <div id="case">
                <h3>Case</h3>
                {% if case.observation_set.count > 1 %}
                <div class="edit-warning">
                    <img
                        src="{% url site-media path="icons/warning.png"%}"
                    >
                    Note that this is the case data for {{ case.observation_set.count|add:"-1" }} other observation{{ case.observation_set.count|add:"-1"|pluralize }}.
                    <img
                        src="{% url site-media path="icons/warning.png"%}"
                    >
                </div>
                {% endif %}
                {{ forms.case.as_p }}
                <div style="text-align:left; float: left;">
                    <a class="link-to-animal" href="#animal">&lt;- previous tab</a>
                </div>
                <div style="text-align: right;">
                    <a class="link-to-reporting" href="#reporting">next tab -&gt;</a>
                </div>
            </div> <!-- id="case" -->
            <div id="reporting">
                <h3>Reporting</h3>
                <div class="section">
                    <h4>report date and time</h4>
                    {% with forms.report_datetime as d_form %}
                    {% include "datetime/edit_datetime_include.html" %}
                    {% endwith %}
                </div>
                <div class="section">
                    <h4>reporter</h4>
                    <script type="text/javascript">
                        $().ready(function(){
                            RadioHider.init('{{ forms.observation.new_reporter.html_name }}', {
                                {# TODO? get the keys from forms.observation.new_reporter.field #}
                                'new': 'reporter_new_contact',
                                'other': 'reporter_existing_contact'
                            });
                        });
                    </script>
                    {% with forms.observation.new_reporter as f %}
                    {% include "unlabeled_field.html" %}
                    {% endwith %}
                    <div id="reporter_new_contact" style="display:none;">
                        {% with forms.new_reporter as form %}
                        {% with forms.new_reporter_affiliations as  new_affiliations %}
                        {% include "contacts/change_contact_include.html" %}
                        {% endwith %}
                        {% endwith %}
                    </div>
                    <div id="reporter_existing_contact" style="display:none;">
                        {% with forms.observation.reporter as f %}
                        {% include "unlabeled_field.html" %}
                        {% endwith %}
                    </div>
                </div>
                <div class="section">
                    {% with forms.observation.documentation as f %}
                    {% include "labeled_field.html" %}
                    {% endwith %}
                </div>
                <div style="text-align:left; float: left;">
                    <a class="link-to-case" href="#case">&lt;- previous tab</a>
                </div>
                <div style="text-align: right;">
                    <a class="link-to-observation" href="#observation">next tab -&gt;</a>
                </div>
            </div> <!-- id="reporting" -->
            <div id="observation">
                <h3>Observation</h3>
                <div class="section">
                    <h4>observation date and time</h4>
                    {% with forms.observation_datetime as d_form %}
                    {% include "datetime/edit_datetime_include.html" %}
                    {% endwith %}
                </div>
                <div class="section">
                    <h4>observer</h4>
                    <script type="text/javascript">
                        $().ready(function(){
                            RadioHider.init('{{ forms.observation.new_observer.html_name }}', {
                                {# TODO get the values from forms.observation.new_observer.field #}
                                'new': 'observer_new_contact',
                                'other': 'observer_existing_contact'
                            });
                        });
                    </script>
                    {% with forms.observation.new_observer as f %}
                    {% include "unlabeled_field.html" %}
                    {% endwith %}
                    <div id="observer_new_contact" style="display:none;">
                        {% with forms.new_observer as form %}
                        {% with forms.new_observer_affiliations as  new_affiliations %}
                        {% include "contacts/change_contact_include.html" %}
                        {% endwith %}
                        {% endwith %}
                    </div>
                    <div id="observer_existing_contact" style="display:none;">
                        {% with forms.observation.observer as f %}
                        {% include "unlabeled_field.html" %}
                        {% endwith %}
                    </div>
                </div> <!-- class="section" -->
                <div class="section">
                    <h4>observation location</h4>
                    {% with forms.location as l_form %}
                    {% include "locations/edit_location_include.html" %}
                    {% endwith %}
                </div>
                <div class="section">
                    {% with forms.observation.observer_on_vessel as f %}
                    {% include "labeled_field.html" %}
                    {% endwith %}
                    <script type="text/javascript">
                        $().ready(function(){
                            CheckboxHider.init(
                                "{{ forms.observation.observer_on_vessel.html_name}}",
                                'vessel_info'
                            );
                        });
                    </script>
                    <div id="vessel_info">
                        <h4>vessel info for observer's vessel</h4>
                        {% with forms.observer_vessel as v_form %}
                        {% with forms.new_vesselcontact as c_form %}
                        {% with forms.new_vesselcontact_affiliations as c_aff_form %}
                        {% include "vessels/edit_vessel_include.html" %}
                        {% endwith %}
                        {% endwith %}
                        {% endwith %}
                    </div>
                </div> <!-- class="section" -->
                <div style="text-align:left; float: left;">
                    <a class="link-to-reporting" href="#reporting">&lt;- previous tab</a>
                </div>
                <div style="text-align: right;">
                    <a class="link-to-animal-identification" href="#animal-identification">next tab -&gt;</a>
                </div>
            </div> <!-- id="observation" -->
            <div id="animal-identification">
                <h3>Animal identification</h3>
                <table>
                    <tr>
                        <th>taxon</th>
                        <td>
                            {% with forms.observation.taxon as f %}
                            {% include "unlabeled_field.html" %}
                            {% endwith %}
                        </td>
                    </tr>
                    <tr>
                        <th>sex</th>
                        <td>
                            {% with forms.observation.gender as f %}
                            {% include "unlabeled_field.html" %}
                            {% endwith %}
                        </td>
                    </tr>
                    <tr>
                        <th>description</th>
                        <td>
                            {% with forms.observation.animal_description as f %}
                            {% include "bigtext_field.html" %}
                            {% endwith %}
                        </td>
                    </tr>
                </table>
                <div>
                    {% with forms.observation.biopsy as f %}
                    {% include "labeled_field.html" %}
                    {% endwith %}
                    {% with forms.observation.tagged as f %}
                    {% include "labeled_field.html" %}
                    {% endwith %}
                </div>
                <div style="text-align:left; float: left;">
                    <a class="link-to-observation" href="#observation">&lt;- previous tab</a>
                </div>
                <div style="text-align: right;">
                    <a class="link-to-incident" href="#incident">next tab -&gt;</a>
                </div>
            </div> <!-- id="animal-identification" -->
            <div id="incident">
                <h3>Incident details</h3>
                <script type="text/javascript">
                    $().ready(function(){
                        SelectHider.init('{{ forms.observation.wounded.html_name }}', {
                            {# TODO? get the keys from forms.observation.wounded.field #}
                            '1': 'observation_wounded',
                            '2': 'observation_wounded'
                        });
                    });
                </script>
                {% block incident_tab_body %}
                {% with forms.observation.wounded as f %}
                {% include "labeled_field.html" %}
                {% endwith %}
                <div id="observation_wounded">
                    {% with forms.observation.wound_description as f %}
                    {% include "bigtext_field.html" %}
                    {% endwith %}
                </div>
                {% endblock %}
                <div style="text-align:left; float: left;">
                    <a class="link-to-animal-identification" href="#animal-identification">&lt;- previous tab</a>
                </div>
                <div style="text-align: right;">
                    <a class="link-to-save" href="#save">next tab -&gt;</a>
                </div>
            </div> <!-- id="incident" -->
            <div id="save">
                <h3>Narrative</h3>
                <div>
                    {% with forms.observation.narrative as f %}
                    {% include "unlabeled_field.html" %}
                    {% endwith %}
                </div>
                <div style="text-align:left; float: left;">
                    <a class="link-to-incident" href="#incident">&lt;- previous tab</a>
                </div>
                <div style="text-align:center;">
                    <button type="submit">{% block submit_button %}NO BUTTON!{% endblock %}</button>
                </div>
            </div>
        </div> <!-- id="tabs" -->
    </div>
</form>
{% endblock %}

